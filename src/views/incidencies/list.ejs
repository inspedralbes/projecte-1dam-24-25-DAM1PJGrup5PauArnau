<%- include('../partials/header', { title: 'Llista d\'Incidències' }) %>

<style>
  .table-success { background-color: #d4edda !important; }
  .table-danger { background-color: #f8d7da !important; }
  .border-success { border-color: #198754 !important; }
  .border-danger { border-color: #dc3545 !important; }
  .table td, .table th {
    border: 2px solid #2a2b2c !important;
    vertical-align: middle;
  }
  .table thead th {
    background-color: #343a40;
    color: white;
  }
  .table-success td, .table-danger td {
    border: 1px solid #2a2b2c !important;
  }
  .table {
    border-collapse: separate;
    border-spacing: 0;
    overflow: hidden;
    color:#2a2b2c;
  }
</style>

<h1 class="mb-4">Llista d'Incidències</h1>
<a class="btn btn-primary mb-3" href="/incidencies/new">Afegir Incidència</a>

<%
  function getPrioritatWeight(prioritat) {
    if (prioritat === 'Alta') return 1;
    if (prioritat === 'Mitjana') return 2;
    return 3; // Baixa
  }

  // Classificació
  const pendentsSenseTecnic = [];
  const pendentsAmbTecnic = [];
  const resoltes = [];

  incidencies.forEach(inc => {
    const actuacionsVisibles = inc.Actuacios?.filter(a => a.visible) || [];
    const ultimaActuacio = actuacionsVisibles[actuacionsVisibles.length - 1];
    const resolta = !!ultimaActuacio?.resolta;

    inc._resolta = resolta;

    if (resolta) {
      resoltes.push(inc);
    } else if (!inc.Tecnic) {
      pendentsSenseTecnic.push(inc);
    } else {
      pendentsAmbTecnic.push(inc);
    }
  });

  // Ordenació
  const ordenar = llista => llista.sort((a, b) => {
    const p1 = getPrioritatWeight(a.prioritat);
    const p2 = getPrioritatWeight(b.prioritat);
    if (p1 !== p2) return p1 - p2;
    return a.id - b.id;
  });

  ordenar(pendentsSenseTecnic);
  ordenar(pendentsAmbTecnic);
  ordenar(resoltes);
%>

<!-- TAULA 1: Pendents sense tècnic -->
<h2>Incidències pendents (Sense tècnic)</h2>
<%- include('partials/incidencia_table', { llista: pendentsSenseTecnic }) %>

<!-- TAULA 2: Pendents amb tècnic -->
<h2>Incidències pendents (Amb tècnic)</h2>
<%- include('partials/incidencia_table', { llista: pendentsAmbTecnic }) %>

<!-- TAULA 3: Resoltes -->
<h2>Incidències resoltes</h2>
<%- include('partials/incidencia_table', { llista: resoltes }) %>

<%- include('../partials/footer') %>
